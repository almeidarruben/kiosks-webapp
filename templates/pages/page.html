{% extends "base.html" %}
{% load mezzanine_tags keyword_tags %}

{% block meta_title %}{{ page.meta_title }}{% endblock %}

{% block meta_keywords %}{% metablock %}
{% keywords_for page as keywords %}
{% for keyword in keywords %}
    {% if not forloop.first %}, {% endif %}
    {{ keyword }}
{% endfor %}
{% endmetablock %}{% endblock %}

{% block meta_description %}{% metablock %}
{{ page.description }}
{% endmetablock %}{% endblock %}

{% block title %}
{% editable page.title %}{{ page.title }}{% endeditable %}
{% endblock %}

{% block main %}

<script type="text/javascript">

function goto(pagina_pk, div_id, parent) {
	var formatedSlug = div_id.replace("/", "-");
	$("#dynamic-content").append("<div id='" + formatedSlug + "' class='page'></div>");

    var divID = document.getElementById(formatedSlug);
	var url = "/get/pagina/"+pagina_pk;
	var returnDivID = parent + "-nav";
	var str = "";

    $.get(url, function(data) {
		if (data.class == "page") {
			divID.innerHTML = "<div class='page-back-button' onclick=\"gotoBack('" + returnDivID + "','"+ formatedSlug +"');\"></div><div class='page-container'><div class='page-text-wrapper-TTFBI'><h1>" + data.pagina.title + "</h1><div class='page-text-TTFBI'><p>" + data.pagina.description + "</p></div><div class='page-text-footer-TTFBI'><p>" + data.pagina.rodape + "</p></div><div class='page-text-buttons-TTFBI'><div class='button button-submit' style='width: 110px;'><a href=''>Centros Associados</a></div></div></div><img src='/media/" + data.pagina.imagem + "' /></div>";
			// FIXME: paragraphs in data.pagina.description & data.pagina.rodape
			// FIXME: media url
			// TODO: meter os botões popup (se existirem) e o respetivo conteúdo (imagem ou vídeo)
        
		} else if (data.class == "submenus") {
			str = "<nav id='" + data.pagina.slug + "-nav' class='page-subnav'>";
			var menuLinks = "";			
			// TODO: botão para voltar para trás

			$.each(data.botoes, function(index, element) {
				menuLinks += "<a href='#' onClick=\"goto('" + element.link_para + "','" + element.slug + "')\"><h1>" + element.titulo + "</h1><h2>" + element.descricao + "</h2></a>";
			});
			
			str += menuLinks;
			str += "</nav>";

			divID.innerHTML = str;

			setNavCss(data.pagina.slug + "-nav", Object.keys(data.botoes).length);
			setZindexOrder("#" + data.pagina.slug + "-nav a");

		} else if (data.class == "contact") {
			divID.innerHTML = "<div id=" + data.pagina.slug + " class='page'><div class='page-back-button' onclick=\"gotoBack('" + returnDivID + "','"+ formatedSlug +"');\"></div><div class='page-container'><div class='page-text-wrapper-C'><h1>" + data.pagina.title + "</h1><div class='page-text-C'><p>" + data.pagina.endereco + "</p><br><p>Email: " + data.pagina.email + "</p><p>Telefone: " + data.pagina.telefone + "</p><p>Fax: " + data.pagina.fax + "</p><p>Web: " + data.pagina.website + "</p></div></div><img class='page-contact-img' src='{{ MEDIA_URL }}" + data.pagina.mapa + "'></div></div>";
            
		} else if (data.class == "list") {
			// TODO: abaixo do content, substituir a barra dos "eventos", "provas" e "notícias" por um filtro com as categorias do protocolo (quando se escolhe, filtra na lista); estilizar selectbox: http://www.bulgaria-web-developers.com/projects/javascript/selectbox/

			if (data.pagina.tipo == "prot_pub") {
				protocolUrl = "/get/items/"+pagina_pk;
				$.get(protocolUrl, function(protocol_data) {
					str = "<div class='protocol-wrapper'><div class='protocol-content'>";
					$.each(protocol_data, function(protocol, element) {
						str += "<div class='protocol-topic'><h1>" + element.titulo + "</h1><p>" + element.objectivos + "</p><div class='protocol-subtitle'><h2>Assinatura:</h2><p>" + element.assinatura + "</p><h2>Termo:</h2><p>" + element.termo + "</p></div><div class='protocol-subtitle'><h2>Unidade:</h2><p>" + element.unidade + "</p></div></div>"
					});
					str += "</div></div>"
					divID.innerHTML = str;
				});
			} else {
				str = "<div id=" + data.pagina.slug + " class='page'><div class='page-back-button' onclick=\"gotoBack('" + returnDivID + "','"+ formatedSlug +"');\"></div><div class='list-wrapper'><h1>" + data.pagina.title + "</h1><div class='list-container'>";

				var catUrl = "/get/items/"+pagina_pk;
				$.get(catUrl, function(list_data) {
					$.each(list_data, function(category, element) {
						str += "<div class='list-item-category'><h1>" + category + "</h1>";
						$.each(element, function(index, e) {
							str += "<div class='list-item'><h2>" + e.titulo +"</h2><div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Candidatura:</p><p>"+ e.candidatura +"</p></div>";

		                    str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Fonte de Financiamento:</p><p>" + e.financiamento + "</p></div>";

		                    str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Unidade:</p><p>" + e.unidade + "</p></div>";

		                    str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Responsável:</p><p>" + e.responsavel + "</p></div></div>";
	                	});
					});
					str += "</div></div>";
					divID.innerHTML = str;
				});
			}
		}

        $(".content-container").animate({"left": -($(divID).position().left)}, 600);
        
		$.get("/get/pagina/"+data.pagina.parent, function(elm) {
			setTimeout(function() {
        		$("#" + elm.pagina.slug).remove();
        		$(divID).offset({left: 0 });
        	}, 700);

		});
    });
};
</script>

{% if page.submenus %}
	<nav id="{{page.submenus.slug}}-nav" class="page-subnav">
	{% for botao in page.submenus.botoes.all %}
	<a href="#" onClick="goto({{ botao.link_para.pk }}, '{{ botao.link_para.slug }}', '{{ page.submenus.slug }}')">
		<h1>{{ botao }}</h1>
		{% if botao.descricao %}
			<h2>{{ botao.descricao }}</h2>
		{% endif %}
	</a>
	{% endfor %}
	</nav>
{% elif page.pagina %}
	<div class="page-back-button" style="visibility: hidden"></div>
	<div class="page-container">
		<div class="page-text-wrapper-TTFBI">
			<h1>{{ page.title }}</h1>
			<div class="page-text-TTFBI">
				<p>{{ page.pagina.texto }}</p>
			</div>
			<div class="page-text-footer-TTFBI">
				<p>{{ page.pagina.rodape }}</p>
			</div>
			{% if page.pagina.botoes_popup %}
			<div class="page-text-buttons-TTFBI">
				{% for botao in page.pagina.botoes_popup.all %}
				<div class="button button-submit" style="width: 110px;">
					<strong><a class="contacts-modal" href='#'>{{ botao.titulo }}</a>
				</div>
				<!-- TODO: ver como preencher o modal -->
				{% endfor %}
			</div>
			{% endif %}
		</div>
	<img src="/media/{{ page.pagina.imagem }}"/>
	</div>

{% elif page.listagem %}
<div id="listagem"></div>

{% if page.listagem.tipo == 'prot_pub' %}
<script>
var divID = document.getElementById("listagem");
var protocolUrl = "/get/items/"+{{ page.pk }};
$.get(protocolUrl, function(protocol_data) {
	str = "<div class='protocol-wrapper'><div class='protocol-content'>";
	$.each(protocol_data, function(protocol, element) {
		str += "<div class='protocol-topic'><h1>" + element.titulo + "</h1><p>" + element.objectivos + "</p><div class='protocol-subtitle'><h2>Assinatura:</h2><p>" + element.assinatura + "</p><h2>Termo:</h2><p>" + element.termo + "</p></div><div class='protocol-subtitle'><h2>Unidade:</h2><p>" + element.unidade + "</p></div></div>"
	});
	str += "</div></div>"
	divID.innerHTML = str;
});
</script>

{% else %}

<script>
var divID = document.getElementById("listagem");

str = "<div id=\"#{{ page.slug }}\" class='page'><div class='page-back-button' style=\"visibility: hidden\"></div><div class='list-wrapper'><h1>{{ page.title }}</h1><div class='list-container'>";

var catUrl = "/get/items/"+{{ page.pk }};
$.get(catUrl, function(list_data) {
	$.each(list_data, function(category, element) {
		str += "<div class='list-item-category'><h1>" + category + "</h1>";
		$.each(element, function(index, e) {
			str += "<div class='list-item'><h2>" + e.titulo +"</h2><div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Candidatura:</p><p>"+ e.candidatura +"</p></div>";

            str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Fonte de Financiamento:</p><p>" + e.financiamento + "</p></div>";

            str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Unidade:</p><p>" + e.unidade + "</p></div>";

            str += "<div class='list-item-parag-wrapper'><p class='list-item-parag-bold'>Responsável:</p><p>" + e.responsavel + "</p></div></div>";
    	});
	});
	str += "</div></div>";
	divID.innerHTML = str;
});

</script>

{% endif %}

{% elif page.contacto %}
	<div class="page-back-button" style="visibility: hidden"></div>
	<div id="{{ page.contacto.slug }}" class="page">
		<div class="page-container">
			<div class="page-text-wrapper-C">
				<h1>{{ page.title }}</h1>
				<div class="page-text-C">
					{% if page.contacto.endereco %}
						<p>{{ page.contacto.endereco }}</p><br>
					{% endif %}
					{% if page.contacto.email %}
					<p>{% trans "Email" %}: {{ page.contacto.email }}</p>
					{% endif %}
					{% if page.contacto.telefone %}
					<p>{% trans "Telefone" %}: {{ page.contacto.telefone }}</p>
					{% endif %}
					{% if page.contacto.fax %}
					<p>{% trans "Fax" %}: {{ page.contacto.fax }}</p>
				{% endif %}
					{% if page.contacto.website %}
					<p>{% trans "Web" %}: {{ page.contacto.website }}</p>
					{% endif %}
				</div>
			</div>
			<img class="page-contact-img" src="/media/{{ page.contacto.mapa }}">
		</div>
	</div>
{% endif %}
<script>
	setNavCss("{{page.submenus.slug}}-nav","{{page.submenus.botoes.count }}");
	setZindexOrder("#{{page.submenus.slug}}-nav a");	
</script>
{% endblock %}

{% block sidebar %}
{% endblock %}
